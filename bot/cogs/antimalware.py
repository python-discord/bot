import logging

from discord import Message, NotFound
from discord.ext.commands import Bot, Cog

from bot.constants import AntiMalware as AntiMalwareConfig, Channels

log = logging.getLogger(__name__)


class AntiMalware(Cog):
    """Delete messages which contain attachments with non-whitelisted file extensions."""

    def __init__(self, bot: Bot):
        self.bot = bot

    @Cog.listener()
    async def on_message(self, message: Message) -> None:
        """Identify messages with prohibited attachments."""
        rejected_attachments = list()
        detected_pyfile = list()
        for attachment in message.attachments:
            if not attachment.filename.lower().endswith(tuple(AntiMalwareConfig.whitelist)):
                rejected_attachments.append(attachment)
            if attachment.filename.lower().endswith('.py'):
                detected_pyfile.append(attachment)

        if rejected_attachments:
            # Send a message to the user indicating the problem (with special treatment for .py)
            author = message.author
            if detected_pyfile:
                msg = (f"{author.mention}, it looks like you tried to attach a Python file - please "
                       f"use a code-pasting service such as https://paste.pythondiscord.com/ instead.")
            else:
                meta_channel = self.bot.get_channel(Channels.meta)
                msg = (f"{author.mention}, it looks like you tried to attach a file type we don't "
                       f"allow. Feel free to ask in {meta_channel.mention} if you think this is a mistake.")

            await message.channel.send(msg)

            # Delete the offending message:
            try:
                await message.delete()
            except NotFound:
                log.info(f"Tried to delete message `{message.id}`, but message could not be found.")


def setup(bot: Bot) -> None:
    """Antimalware cog load."""
    bot.add_cog(AntiMalware(bot))
    log.info("Cog loaded: AntiMalware")
